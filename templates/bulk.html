{% extends "base.html" %}
{% block content %}

<h3>Bulk WhatsApp Sender</h3>

<form id="f" enctype="multipart/form-data" class="card p-3">

<input type="file" name="excel" id="excel" class="form-control mb-2" required>

<div class="row mb-2">
  <div class="col"><input name="start_row" class="form-control" value="1"></div>
  <div class="col"><input name="end_row" class="form-control" placeholder="Auto-detect"></div>
  <div class="col"><input name="batch_size" class="form-control" value="30"></div>
</div>

<h6>Timing (seconds)</h6>
<div class="row mb-2">
  <div class="col"><input name="open_min" class="form-control" value="5"></div>
  <div class="col"><input name="open_max" class="form-control" value="10"></div>
  <div class="col"><input name="type_min" class="form-control" value="5"></div>
  <div class="col"><input name="type_max" class="form-control" value="10"></div>
</div>
<div class="row mb-2">
  <div class="col"><input name="send_min" class="form-control" value="5"></div>
  <div class="col"><input name="send_max" class="form-control" value="10"></div>
  <div class="col"><input name="next_min" class="form-control" value="5"></div>
  <div class="col"><input name="next_max" class="form-control" value="10"></div>
</div>
<div class="row mb-2">
  <div class="col"><input name="batch_min" class="form-control" value="60"></div>
  <div class="col"><input name="batch_max" class="form-control" value="120"></div>
</div>

<h6>Fallback Messages</h6>
{% for i in range(1,6) %}
<textarea name="msg{{i}}" class="form-control mb-2" placeholder="Message {{i}}"></textarea>
{% endfor %}

<button class="btn btn-success w-100">Start</button>
</form>

<div class="mt-3">
<button onclick="fetch('/pause')" class="btn btn-warning">Pause</button>
<button onclick="fetch('/resume')" class="btn btn-primary">Resume</button>
</div>

<div class="progress mt-3">
  <div id="bar" class="progress-bar" style="width:0%"></div>
</div>

<p id="st"></p>

<script>
document.getElementById("excel").onchange = function(){
  let fd = new FormData();
  fd.append("excel", this.files[0]);
  fetch("/excel-info",{method:"POST",body:fd})
    .then(r=>r.json())
    .then(d=>{
      document.querySelector('[name="end_row"]').value=d.rows;
    });
};

document.getElementById("f").onsubmit = function(e){
  e.preventDefault();
  fetch("/bulk",{method:"POST",body:new FormData(this)});
};

setInterval(()=>{
fetch("/progress").then(r=>r.json()).then(p=>{
  let done=p.sent+p.failed;
  let percent=p.total?(done/p.total)*100:0;
  document.getElementById("bar").style.width=percent+"%";
  document.getElementById("st").innerText=
    `Status: ${p.status} | Sent: ${p.sent} Failed: ${p.failed}/${p.total}`;
});
},2000);
</script>

{% endblock %}
